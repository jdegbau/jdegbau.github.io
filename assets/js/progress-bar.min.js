(function () {
    const contentSelectors = ['article', '.post', '.post-body', '.post-content', 'main'];
    const bar = document.getElementById('progress-bar') || document.querySelector('.progress-bar');
    let content = null;
    let contentObserver = null;

    function findContent() {
        // prefer the largest matching element (helps avoid small header/teaser matches)
        let best = null;
        let bestH = 0;
        for (const s of contentSelectors) {
            document.querySelectorAll(s).forEach(el => {
                const h = el.getBoundingClientRect().height || el.offsetHeight || 0;
                if (h > bestH) { bestH = h; best = el; }
            });
        }
        return best;
    }

    function headerHeight() {
        const h = document.querySelector('.site-header, header, .navbar');
        return h ? h.getBoundingClientRect().height : 0;
    }

    function updateProgress() {
        if (!bar) return;
        const doc = document.documentElement;
        const body = document.body;
        const scrollTop = window.pageYOffset || doc.scrollTop || body.scrollTop || 0;
        const docHeight = Math.max(body.scrollHeight, doc.scrollHeight, body.offsetHeight, doc.offsetHeight, body.clientHeight, doc.clientHeight);
        const windowHeight = window.innerHeight || doc.clientHeight || body.clientHeight;
        const total = Math.max(docHeight - windowHeight, 1);
        const progress = Math.min(Math.max(scrollTop / total, 0), 1);
        bar.style.width = (progress * 100) + '%';
    }

    const rafTick = (() => {
        let scheduled = false;
        return function () {
            if (scheduled) return;
            scheduled = true;
            requestAnimationFrame(() => { scheduled = false; updateProgress(); });
        };
    })();

    function bindImageLoads() {
        document.querySelectorAll('img').forEach(img => {
            if (!img.complete) img.addEventListener('load', rafTick);
        });
    }

    function observeContent() {
        if (!content) return;
        if (contentObserver) contentObserver.disconnect();
        contentObserver = new MutationObserver(rafTick);
        contentObserver.observe(content, { childList: true, subtree: true, attributes: true });
    }

    function init() {
        content = findContent();
        if (!content) {
            // If content not present yet, watch body until it appears
            const rootObserver = new MutationObserver(() => {
                content = findContent();
                if (content) {
                    rootObserver.disconnect();
                    bindImageLoads();
                    observeContent();
                    rafTick();
                }
            });
            rootObserver.observe(document.body, { childList: true, subtree: true });
            return;
        }

        bindImageLoads();
        observeContent();
        rafTick();
    }

    window.addEventListener('scroll', rafTick, { passive: true });
    window.addEventListener('resize', rafTick);
    window.addEventListener('load', () => { rafTick(); bindImageLoads(); });

    init();
})();